# Connecting R and ArcGIS Online

To connect R with ArcGIS Online (AGOL) you will need to use ESRI's [R-ArcGIS Bridge](https://developers.arcgis.com/r-bridge/), which is a collection of R packages that integrates R with ArcGIS. The easiest way to install the R-ArcGIS Bridge is to install the {argis} metapackage,
```{r, eval = FALSE}
install.packages("arcgis", repos = c("https://r-arcgis.r-universe.dev", "https://cloud.r-project.org"))
```

It is recommended that you have the newest version of R installed, with a minimum version number of 4.3 or higher.

Once you have installed {arcgis} you can load all the packages using,
```{r, eval = FALSE}
library(arcgis)
```

This will include:
- arcgisutils 
- arcgislayers 
- arcgisgeocode
- arcgisplaces

The rest of this tutorial will show you how to 1) find a feature layer url from the [MDEB GIS Data Hub](https://mdeb-nefsc-noaa.hub.arcgis.com/) and 2) read in data from that feature layer.

## Find a feature layer url

Navigate to the [MDEB GIS Data Hub](https://mdeb-nefsc-noaa.hub.arcgis.com/).
```{r, echo = FALSE, out.width = "100%", fig.cap = "MDEB GIS Data Hub"}
knitr::include_graphics("img/mdeb_gis_data_hub.png")
```

Find the survey you are interested in and scroll down to the `I want to...` section.
```{r, echo = FALSE, out.width = "100%"}
knitr::include_graphics("img/mdeb_gis_data_hub_ecomon.png")
```

Click on the `View Data Source` link.
```{r, echo = FALSE, out.width = "100%"}
knitr::include_graphics("img/mdeb_gis_data_hub_ecomon_data.png")
```

This will bring you to the feature service page.
```{r, echo = FALSE, out.width = "100%"}
knitr::include_graphics("img/mdeb_gis_data_hub_ecomon_feature.png")
```

Now copy the url in the address bar and store it in an R object, this is the url of the remote resource (feature service) that you will need for the next subsection.
```{r, echo = TRUE, eval = FALSE}
## url for EcoMon Strata feature layer
ecomon_url <- 'https://services2.arcgis.com/C8EMgrsFcRFL6LrL/arcgis/rest/services/Ecosystem_Monitoring_Survey/FeatureServer/1'
```

## Read in data from a feature layer

Now we will use the `arc_read()` function to extract the data from the EcoMon Strata feature layer and store the results in an R object called `ecomon_strata`.
```{r, echo = TRUE}
## Download EcoMon Survey strata from the MDEB GIS Data Hub
ecomon_strata <- arc_read(url = ecomon_url)
ecomon_strata

#> Simple feature collection with 48 features and 11 fields
#> Geometry type: POLYGON
#> Dimension:     XY
#> Bounding box:  xmin: -75.96791 ymin: 35.14219 xmax: -65.16869 ymax: 44.48558
#> Geodetic CRS:  NAD83
#> First 10 features:
#>    OBJECTID                 SURVEY_NAME NUMOFPOLY NUMOFSTA REGION     AREA TYPE     ACRES Shape__Area Shape__Length
#> 1         1 Ecosystem Monitoring Survey         1        1    MAB 1540.432   SB  380709.0   0.1540434      2.314193
#> 2         2 Ecosystem Monitoring Survey         1        2    MAB 4496.485   MS 1110526.3   0.4498022      3.273956
#> 3         3 Ecosystem Monitoring Survey         1        2    MAB 3190.414   IS  788464.8   0.3184615      3.374652
#> 4         4 Ecosystem Monitoring Survey         1        1    MAB 2510.323   SB  620508.7   0.2548203      3.274308
#> 5         5 Ecosystem Monitoring Survey         1        5    MAB 9620.144   MS 2378814.2   0.9760387      4.144637
#> 6         6 Ecosystem Monitoring Survey         1        2    MAB 2726.496   IS  673994.9   0.2762439      3.118843
#> 7         7 Ecosystem Monitoring Survey         1        2    MAB 4804.352   SB 1187883.9   0.4939513      4.031104
#> 8         8 Ecosystem Monitoring Survey         1        4    MAB 8095.956   MS 2001253.5   0.8353470      3.985027
#> 9         9 Ecosystem Monitoring Survey         1        1    MAB 2391.726   IS  591364.0   0.2455178      2.838412
#> 10       10 Ecosystem Monitoring Survey         1        3    MAB 4720.303   SB 1167316.5   0.4908978      3.187865
#>    STR_NAME                       geometry
#> 1         1 POLYGON ((-74.76881 36.5052...
#> 2         2 POLYGON ((-74.81583 36.5052...
#> 3         3 POLYGON ((-75.72364 36.5060...
#> 4         4 POLYGON ((-74.3466 37.56465...
#> 5         5 POLYGON ((-74.63893 37.7118...
#> 6         6 POLYGON ((-75.54484 37.5418...
#> 7         7 POLYGON ((-73.38887 38.4968...
#> 8         8 POLYGON ((-74.44489 39.0486...
#> 9         9 POLYGON ((-74.93782 38.5007...
#> 10       10 POLYGON ((-72.7857 39.20539..
```

```{r, echo = TRUE, eval = FALSE}
## Plot
plot(ecomon_strata['REGION'])
```

```{r, echo = FALSE, out.width = "100%"}
knitr::include_graphics("img/ecomon_strata.png")
```

You can also use SQL where clauses to limit the number of rows returned from the hosted feature layer, especially if you only need a subset. This can be very efficient, as reading a subset of data into memory will be faster and less costly, relative to th entire dataset. 

```{r, echo = TRUE, eval = FALSE}
## Open connection to the EcoMon Strata feature layer
ecomon_open = arc_open(url = ecomon_url)
ecomon_open

## Query for only SNE strata
ecomon_sne = arc_select(x = ecomon_open, where = "REGION = 'SNE'")
plot(ecomon_sne['REGION'])
```

```{r, echo = FALSE, out.width = "100%"}
knitr::include_graphics("img/ecomon_sne_strata.png")
```

# Connecting python and ArcGIS

This code is for connecting to arcgis.com via the ArcGIS API for python, refer to <https://github.com/Esri/arcgis-python-api> for source code. Further documentation at <https://developers.arcgis.com/python/latest/>.

```{python, eval = FALSE, python.reticulate = FALSE}
# load libraries
import arcpy
import arcgis
from arcgis.gis import GIS
from arcgis.features import FeatureLayer
import pandas as pd
import geopandas as gpd
import matplotlib.pyplot as plt
from shapely.geometry import Polygon

# log into arcgis online
# see documentation for logging in with various authentication schemes 
# https://developers.arcgis.com/python/latest/guide/working-with-different-authentication-schemes/
user = "" # enter arcgis.com username
password = "" # enter arcgis.com password
portal = "https://noaa.maps.arcgis.com/"
gis = GIS(portal, user, password)

# alternatively, log in using ArcGIS Pro, if Pro is on system computer and is logged into the portal
gis = GIS("PRO")

# test arcis.com connection
if gis is not None and gis._portal.is_logged_in:
  print(f"Successfully logged in as: {gis.properties.user['username']}")
else:
  print("Login failed.")

# example map
# pull data from arcgis online using feature server url, from ArcGIS REST API
# in this example, taking the World Continents feature layer from Living Atlas 
item_url = "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Continents/FeatureServer/0"

# retrieve item from arcgis online
world_layer = FeatureLayer(item_url)

# query feature layer to return all data
world_features = world_layer.query(where="1=1")

# create a list to hold the geometries
geometries = []

# loop through features to extract geometries
for feature in world_features.features:
  geom = feature.geometry
  if geom['rings']:
    for ring in geom['rings']:
      polygon = Polygon(ring)
      geometries.append(polygon)

# create geopandas dataframe
gdf = gpd.GeoDataFrame(geometry=geometries)

# create map using geopandas
fig,ax = plt.subplots(figsize=(10,6))
gdf.plot(ax=ax, color='#9bc04b', edgecolor='black') #set fill color and border color
plt.title('World Map') #set map title
ax.set_xticks([]) #remove tick marks
ax.set_yticks([])
ax.xaxis.set_ticklabels([]) #remove tick labels
ax.yaxis.set_ticklabels([])
plt.ylim(-9000000,20000000) #set limits of y axis 
plt.show()
```

```{r, echo=FALSE, out.width="100%", fig.cap="World map"}
knitr::include_graphics("img/World_map.png")
```
