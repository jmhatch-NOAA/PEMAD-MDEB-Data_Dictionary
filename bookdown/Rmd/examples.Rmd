# Connecting R and ArcGIS Online

To connect R with ArcGIS Online (AGOL) you will need to use ESRI's [R-ArcGIS Bridge](https://developers.arcgis.com/r-bridge/), which is a collection of R packages that integrates R with ArcGIS. The easiest way to install the R-ArcGIS Bridge is to install the {argis} metapackage,
```{r, eval = FALSE}
install.packages("arcgis", repos = c("https://r-arcgis.r-universe.dev", "https://cloud.r-project.org"))
```

It is recommended that you have the newet version of R installed, with a minimum version number of 4.3 or higher.

Once you have installed {arcgis} you can load all the packages using,
```{r, eval = FALSE}
library(arcgis)
```

This will include:
- arcgisutils 
- arcgislayers 
- arcgisgeocode
- arcgisplaces

The rest of this tutorial will show you how to 1) find a feature layer url from the [MDEB GIS Data Hub](https://mdeb-nefsc-noaa.hub.arcgis.com/) and 2) read in data from that feature layer.

## Find a feature layer url

Navigate to the [MDEB GIS Data Hub](https://mdeb-nefsc-noaa.hub.arcgis.com/).

```{r, echo = FALSE, out.width = "100%", fig.cap = "MDEB GIS Data Hub"}
knitr::include_graphics("img/mdeb_gis_data_hub.png")
```

Find the survey you are interested in and scroll down to the `I want to...` section.

```{r, echo = FALSE, out.width = "100%"}
knitr::include_graphics("img/mdeb_gis_data_hub_ecomon.png")
```

Click on the `View Data Source` link.

```{r, echo = FALSE, out.width = "100%"}
knitr::include_graphics("img/mdeb_gis_data_hub_ecomon_data.png")
```

This will bring you to the feature service page.

```{r, echo = FALSE, out.width = "100%"}
knitr::include_graphics("img/mdeb_gis_data_hub_ecomon_feature.png")
```

Now copy the url in the address bar.

# Connecting python and ArcGIS

This code is for connecting to arcgis.com via the ArcGIS API for python, refer to <https://github.com/Esri/arcgis-python-api> for source code. Further documentation at <https://developers.arcgis.com/python/latest/>.

```{python, eval = FALSE, python.reticulate = FALSE}
# load libraries
import arcpy
import arcgis
from arcgis.gis import GIS
from arcgis.features import FeatureLayer
import pandas as pd
import geopandas as gpd
import matplotlib.pyplot as plt
from shapely.geometry import Polygon

# log into arcgis online
# see documentation for logging in with various authentication schemes 
# https://developers.arcgis.com/python/latest/guide/working-with-different-authentication-schemes/
user = "" # enter arcgis.com username
password = "" # enter arcgis.com password
portal = "https://noaa.maps.arcgis.com/"
gis = GIS(portal, user, password)

# alternatively, log in using ArcGIS Pro, if Pro is on system computer and is logged into the portal
gis = GIS("PRO")

# test arcis.com connection
if gis is not None and gis._portal.is_logged_in:
  print(f"Successfully logged in as: {gis.properties.user['username']}")
else:
  print("Login failed.")

# example map
# pull data from arcgis online using feature server url, from ArcGIS REST API
# in this example, taking the World Continents feature layer from Living Atlas 
item_url = "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Continents/FeatureServer/0"

# retrieve item from arcgis online
world_layer = FeatureLayer(item_url)

# query feature layer to return all data
world_features = world_layer.query(where="1=1")

# create a list to hold the geometries
geometries = []

# loop through features to extract geometries
for feature in world_features.features:
  geom = feature.geometry
  if geom['rings']:
    for ring in geom['rings']:
      polygon = Polygon(ring)
      geometries.append(polygon)

# create geopandas dataframe
gdf = gpd.GeoDataFrame(geometry=geometries)

# create map using geopandas
fig,ax = plt.subplots(figsize=(10,6))
gdf.plot(ax=ax, color='#9bc04b', edgecolor='black') #set fill color and border color
plt.title('World Map') #set map title
ax.set_xticks([]) #remove tick marks
ax.set_yticks([])
ax.xaxis.set_ticklabels([]) #remove tick labels
ax.yaxis.set_ticklabels([])
plt.ylim(-9000000,20000000) #set limits of y axis 
plt.show()
```

```{r, echo=FALSE, out.width="100%", fig.cap="World map"}
knitr::include_graphics("img/World_map.png")
```
